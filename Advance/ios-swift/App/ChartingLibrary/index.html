<!DOCTYPE HTML>
<html>

<head>

	<title>TradingView Advanced Charts demo</title>

	<!-- Fix for iOS Safari zooming bug -->
	<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">
	<script type="text/javascript" src="custom_y_axis.js"></script>
	<script type="text/javascript" src="datafeed.js"></script>
	<script type="text/javascript" src="charting_library/charting_library.standalone.js"></script>
	<script type="text/javascript" src="datafeeds/udf/dist/bundle.js"></script>
	<script type="text/javascript" src="custom_crosshair.js"></script>
	<link rel="stylesheet" href="custom_crosshair.css">

	<script type="text/javascript">
		function getParameterByName(name) {
			name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
			var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
				results = regex.exec(location.search);
			return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
		}

		window.onload = function () {
			const seriesDocument = document.getElementById('tv_chart_container').querySelector('iframe').contentDocument.documentElement
			const studiesDocument = document.getElementById('studies_chart_container').querySelector('iframe').contentDocument.documentElement
			observeCrosshairMove(seriesDocument, true);
			observeCrosshairMove(studiesDocument, false);
		};

		function initOnReady() {
			var datafeedUrl = "https://demo-feed-data.tradingview.com";
			var customDataUrl = getParameterByName('dataUrl');
			if (customDataUrl !== "") {
				datafeedUrl = customDataUrl.startsWith('https://') ? customDataUrl : `https://${customDataUrl}`;
			}

			var datasource = new Datafeeds.UDFCompatibleDatafeed(datafeedUrl, undefined, {
				maxResponseLength: 1000,
				expectedOrder: 'latestFirst',
			})

			var seriesWidget = window.tvWidget = buildWidget(430, 260, "tv_chart_container", datasource);
			var studiesWidget = window.tvWidget2 = buildWidget(430, 300, "studies_chart_container", datasource);

			// 主图
			seriesWidget.onChartReady(() => {
				seriesWidget.activeChart().onVisibleRangeChanged().subscribe(null, function ({ from, to }) {
					console.log("visible range changed: ", from, to)
					// 时间轴监听(实现不同widget的时间轴同步)
					var visibleRange = studiesWidget.activeChart().getVisibleRange();
					if (visibleRange.from === from && visibleRange.to === to) {
						return;
					}
					studiesWidget.activeChart().setVisibleRange({ from: from, to: to });
				});
				refreshAllPanesCustomYAxis(seriesWidget);
			});

			// 指标线图
			studiesWidget.onChartReady(() => {
				// hidden series chart
				const chart = studiesWidget.activeChart();
				chart.getSeries().setVisible(false);

				// create studies
				chart.createStudy('Volume', true, false).then(entityId => {
					refreshAllPanesCustomYAxis(studiesWidget);
					var indicator = studiesWidget.activeChart().getStudyById(entityId);
					indicator.startFullscreen();
					indicator.applyOverrides({
						'showLabelsOnPriceScale': false,
					});
				});
				chart.createStudy('MACD', false, false).then(entityId => {
					refreshAllPanesCustomYAxis(studiesWidget);
					var indicator = studiesWidget.activeChart().getStudyById(entityId);
					indicator.applyOverrides({
						'showLabelsOnPriceScale': false,
					});
				});
				chart.createStudy('Relative Strength Index', false, false).then(entityId => {
					refreshAllPanesCustomYAxis(studiesWidget);
					var indicator = studiesWidget.activeChart().getStudyById(entityId);
					indicator.applyOverrides({
						'showLabelsOnPriceScale': false,
					});
				});

				// sync time range between two widgets
				chart.onVisibleRangeChanged().subscribe(null, function ({ from, to }) {
					console.log("visible range changed: ", from, to);
					var visibleRange = seriesWidget.activeChart().getVisibleRange();
					if (visibleRange.from === from && visibleRange.to === to) {
						return;
					}
					seriesWidget.activeChart().setVisibleRange({ from: from, to: to });
				});

				// https://www.tradingview.com/charting-library-docs/latest/api/interfaces/Charting_Library.SubscribeEventsMap/#panes_height_changed
				studiesWidget.subscribe('panes_height_changed', function () {
					var panes = studiesWidget.activeChart().getPanes().length;
					studiesWidget.activeChart().setAllPanesHeight([100, 100, 100]);
				});

				refreshAllPanesCustomYAxis(studiesWidget);
			});

		};

		function getBarsDataCallBack(jsonData) {
			// Native can't directly pass JSONString to getBarsCallback, need to parse it first
			var data = JSON.parse(jsonData);
			window.getBarsCallback(data);
			console.log(`============= getBarsData called ${data}`);
		}
        
        function callNativeFunction() {
            window.webkit.messageHandlers.nativeHandler.postMessage("Hello from JavaScript!");
        }

		// 画图工具
		// type: https://www.tradingview.com/charting-library-docs/latest/api/modules/Charting_Library/#supportedlinetools
		function drawTool(type) {
			window.tvWidget.selectLineTool(type, null);
		}

		// 更新Symbol
		function setSymbol(symbol) {
			window.tvWidget.activeChart().setSymbol('IBM');
		}

		function buildWidget(width, height, containerId, datasource) {
			var datafeedUrl = "https://demo-feed-data.tradingview.com";
			var customDataUrl = getParameterByName('dataUrl');
			if (customDataUrl !== "") {
				datafeedUrl = customDataUrl.startsWith('https://') ? customDataUrl : `https://${customDataUrl}`;
			}
			return new TradingView.widget({
				debug: true, // uncomment this line to see Library errors and warnings in the console
				// fullscreen: true,
				// autosize: true,
				width: width,
				height: height,
				symbol: 'AAPL',
				interval: 'D',
				container: containerId,

				// BEWARE: no trailing slash is expected in feed URL
				datafeed: datasource,
				// datafeed: chartDataFetcher,
				library_path: "charting_library/",
				locale: getParameterByName('lang') || "en",

				// disabled_features: ["use_localstorage_for_settings"],
				enabled_features: ["study_templates"],
				charts_storage_url: 'https://saveload.tradingview.com',
				charts_storage_api_version: "1.1",
				client_id: 'tradingview.com',
				user_id: 'public_user_id',
				theme: getParameterByName('theme'),
				timezone: 'Asia/Hong_Kong',
				supports_marks: false,  // 禁用标记显示

				disabled_features: [
					"header_widget", 	// 隐藏顶部的视图
					"left_toolbar", 	// 隐藏左侧的工具栏
					"legend_widget", 	// 隐藏顶部的symbol视图
					"timeframes_toolbar",	// 隐藏底部的时间刻度
					"main_series_scale_menu", // 隐藏底部的设置按钮
					"create_volume_indicator_by_default" // 不显示成交量图表
				],

				enabled_features: [
				],

				overrides: {
					// https://www.tradingview.com/charting-library-docs/latest/api/interfaces/Charting_Library.ChartPropertiesOverrides#mainseriespropertiesbaselinestylebottomlinewidth
					"mainSeriesProperties.style": 0,  // 设置主系列样式为 0（无显示）
					"mainSeriesProperties.visible": false, // 隐藏主系列
					"paneProperties.legendProperties.showStudyTitles": true,
					"paneProperties.legendProperties.showStudyValues": true,
					"mainSeriesProperties.showPriceLine": false,  // 隐藏价格线
					"symbolWatermarkProperties.color": "rgba(0, 0, 0, 0)", 
					"scalesProperties.showSeriesLastValue": false,  // 隐藏最新值标记
					"scalesProperties.showRightScale": false, // 隐藏右侧刻度
					"scalesProperties.showHighAndLow": false, // 隐藏最高最低值
					"paneProperties.crossHairProperties.color": "rgba(0, 0, 0, 0)", // 隐藏studies图表的十字线
					"scalesProperties.showTimeScaleCrosshairLabel": false, // 隐藏时间轴十字线对应的label
					"scalesProperties.showPriceScaleCrosshairLabel": false	// 隐藏Y轴十字线对应的label
				}
			});
		}

		window.addEventListener('DOMContentLoaded', initOnReady, false);
	</script>

</head>

<body style="margin:0px;">
	<div id="tv_chart_container"></div>
	<div id="customerDiv" class="customerDiv"></div>
	<div id="studies_chart_container"></div>

	<div id="vertical-line" class="vertical-line" style="display: none;"></div>
	<div id="horizontal-line" class="horizontal-line" style="display: none;"></div>
	<div id="x-axis-label" class="x-axis-label" style="display: none;"></div>
	<div id="y-axis-label" class="y-axis-label" style="display: none;"></div>
</body>

</html>
